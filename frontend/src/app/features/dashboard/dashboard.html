<div class="dashboard-container">
  <header class="dashboard-header">
    <div class="header-left">
      <mat-icon class="logo">description</mat-icon>
      <span class="title">LiveSync Dashboard</span>
    </div>
    <div class="header-right">
      <span class="user-name">{{ authService.user()?.userName }}</span>
      <button mat-icon-button [matMenuTriggerFor]="menu">
        <mat-icon>account_circle</mat-icon>
      </button>
      <mat-menu #menu="matMenu">
        <button mat-menu-item disabled>
          <span>{{ authService.user()?.email }}</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="logout()">
          <mat-icon>logout</mat-icon>
          <span>Sign Out</span>
        </button>
      </mat-menu>
    </div>
  </header>

  <main class="dashboard-content">
    <!-- Create New Document Section -->
    <section class="create-section">
      <h2>Create New Document</h2>
      <div class="create-form">
        <input
          type="text"
          [(ngModel)]="newDocTitle"
          placeholder="Enter document title"
          (keyup.enter)="createNewDocument()"
          class="doc-input"
        />
        <button (click)="createNewDocument()" [disabled]="isCreating()" class="btn-create">
          {{ isCreating() ? 'Creating...' : '+ New Document' }}
        </button>
      </div>
    </section>

    <!-- My Documents Section -->
    <section class="documents-section">
      <h2>My Documents</h2>
      @if (isLoading()) {
      <div class="loading">Loading documents...</div>
      } @else if (myDocuments().length === 0) {
      <div class="empty-state">
        <p>No documents yet. Create your first document above!</p>
      </div>
      } @else {
      <div class="documents-grid">
        @for (doc of myDocuments(); track doc.id) {
        <div class="document-card">
          <div class="doc-header">
            <h3>{{ doc.title }}</h3>
            <button mat-icon-button [matMenuTriggerFor]="docMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #docMenu="matMenu">
              <button mat-menu-item (click)="openShareModal(doc)">
                <mat-icon>share</mat-icon>
                <span>Share Document</span>
              </button>
              <button mat-menu-item (click)="confirmDelete(doc.id)">
                <mat-icon>delete</mat-icon>
                <span>Delete</span>
              </button>
            </mat-menu>
          </div>
          <p class="doc-meta">Created: {{ doc.createdAt | date : 'short' }}</p>
          @if (doc.lastEditedAt) {
          <p class="doc-meta">
            Last edited: {{ doc.lastEditedAt | date : 'short' }} by {{ doc.lastEditedBy }}
          </p>
          } @if (doc.sharedWith.length > 0) {
          <p class="doc-shared">Shared with {{ doc.sharedWith.length }} user(s)</p>
          }
          <button (click)="openDocument(doc.id)" class="btn-open">Open Document</button>
        </div>
        }
      </div>
      }
    </section>

    <!-- Shared With Me Section -->
    <section class="documents-section">
      <div class="shared-header">
        <h2>Shared With Me</h2>
        <button (click)="goToAddShared()" class="btn-add-shared">+ Add Shared Document</button>
      </div>
      @if (sharedDocuments().length === 0) {
      <div class="empty-state">
        <p>No documents shared with you yet.</p>
      </div>
      } @else {
      <div class="documents-grid">
        @for (doc of sharedDocuments(); track doc.id) {
        <div class="document-card shared">
          <div class="doc-header">
            <h3>{{ doc.documentTitle }}</h3>
            <span class="owner-badge">by {{ doc.userName }}</span>
          </div>
          <p class="doc-meta">Shared: {{ doc.sharedAt | date : 'short' }}</p>
          <p class="access-level">
            Access: <strong>{{ doc.accessLevel }}</strong>
          </p>
          <button (click)="openSharedDoc(doc.documentId)" class="btn-open">Open Document</button>
        </div>
        }
      </div>
      }
    </section>
  </main>

  <!-- Share Modal -->
  @if (showShareModal()) {
  <div class="modal-overlay" (click)="closeShareModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h2>Share Document: {{ selectedDocForShare()?.title }}</h2>
      <div class="share-code-section">
        <p>Share this code with others to let them access your document:</p>
        <div class="share-code-display">
          <input type="text" [value]="shareCode()" readonly class="share-code-input" />
          <button (click)="copyShareCode()" class="btn-copy">Copy Code</button>
        </div>

        <div class="default-access-level">
          <label for="defaultAccessLevel"><strong>Default Access Level:</strong></label>
          <select
            id="defaultAccessLevel"
            [(ngModel)]="defaultAccessLevel"
            (change)="updateDefaultAccessLevel()"
            class="access-select"
          >
            <option value="View">View Only</option>
            <option value="Edit">Can Edit</option>
          </select>
          <p class="access-hint">
            @if (defaultAccessLevel() === 'View') {
            <span>üìñ People using this code will have <strong>view-only</strong> access.</span>
            } @else {
            <span>‚úèÔ∏è People using this code will be able to <strong>view and edit</strong>.</span>
            }
          </p>
        </div>

        <button (click)="regenerateShareCode()" class="btn-regenerate">Generate New Code</button>
      </div>

      @if (selectedDocForShare()?.sharedWith?.length! > 0) {
      <div class="shared-users">
        <h3>Shared With:</h3>
        @for (user of selectedDocForShare()?.sharedWith; track user.userId) {
        <div class="user-item">
          <div class="user-info">
            <span class="user-name">{{ user.userName }}</span>
            @if (editingAccessLevelFor() === user.userId) {
            <select
              [(ngModel)]="user.accessLevel"
              class="access-select-inline"
              (change)="
                updateSharedAccessLevel(selectedDocForShare()!.id, user.userId, user.accessLevel)
              "
            >
              <option value="View">View Only</option>
              <option value="Edit">Can Edit</option>
            </select>
            } @else {
            <span class="access-badge" [class.edit-access]="user.accessLevel === 'Edit'">
              {{ user.accessLevel === 'Edit' ? '‚úèÔ∏è Can Edit' : 'üìñ View Only' }}
            </span>
            <button
              (click)="editingAccessLevelFor.set(user.userId)"
              class="btn-change-access"
              title="Change access level"
            >
              Change
            </button>
            }
          </div>
          <button
            (click)="removeSharedAccess(selectedDocForShare()!.id, user.userId)"
            class="btn-remove"
          >
            Remove
          </button>
        </div>
        }
      </div>
      }

      <button (click)="closeShareModal()" class="btn-close">Close</button>
    </div>
  </div>
  }

  <!-- Delete Confirmation Modal -->
  @if (showDeleteConfirm()) {
  <div class="modal-overlay" (click)="showDeleteConfirm.set(false)">
    <div class="modal-small" (click)="$event.stopPropagation()">
      <h2>Delete Document?</h2>
      <p>This action cannot be undone.</p>
      <div class="modal-actions">
        <button (click)="showDeleteConfirm.set(false)" class="btn-cancel">Cancel</button>
        <button (click)="deleteDocument()" class="btn-delete">Delete</button>
      </div>
    </div>
  </div>
  }

  <!-- Editor Modal -->
  @if (showEditorModal()) {
  <div class="editor-modal-overlay">
    <div class="editor-modal-container">
      <button class="editor-close-btn" (click)="closeEditor()" mat-icon-button>
        <mat-icon>close</mat-icon>
      </button>
      <app-editor [documentId]="selectedDocId()" [isModal]="true"></app-editor>
    </div>
  </div>
  }
</div>
